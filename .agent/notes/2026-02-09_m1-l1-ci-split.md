# Task Note: 2026-02-09 m1-l1-ci-split

## Task
- Request: Implement `M1 + L1` CI split for fast checks vs DB-backed integration required checks.
- Scope: update CI workflow job structure, document required branch checks, and refresh roadmap/agent state.
- Constraints: keep DB-backed integration required, keep diffs reviewable, and run relevant checks before finalizing.

## Actions Taken
1. Split `.github/workflows/ci.yml` API checks into `api-fast` and `api-integration-db` jobs.
2. Kept Postgres provisioning/schema apply only in `api-integration-db` and restricted that job to `api/tests/test_discovery_jobs_integration.py`.
3. Updated `README.md` with explicit required branch-check names and refreshed roadmap + project-mode capture files.

## What Went Wrong
1. Issue: Integration job initially still included API lint/typecheck, duplicating work from fast checks.
- Root cause: first patch renamed/split the job but retained inherited steps from the original monolithic API job.
- Early signal missed: immediate post-patch review showed duplicate lint/typecheck commands still present in both jobs.
- Prevention rule: after CI job splits, run a step-level diff review to ensure each lane contains only lane-specific steps.

## What Went Right
1. Improvement: CI now has an explicit fast lane and a dedicated DB-backed integration lane with clear required-check names.
- Evidence (time/readability/performance/manageability/modularity): integration-only infra setup (Postgres + schema apply) is isolated from lint/typecheck/unit checks, reducing coupling and clarifying gate intent.
- Why it worked: integration tests already lived in a dedicated module, so lane separation was a direct workflow-level change without test rewrites.

## Reusable Learnings
1. Learning: keep DB-backed integration in a dedicated job and exclude integration module from fast pytest runs.
- Promotion decision: `promote now`
- Promote to (if `promote now`): `RUNBOOK.md`
- Why: this is a recurring CI pattern for mixed fast/integration pipelines and reduces accidental gate coupling.

## Receipts
- Commands run:
  - `uv run --project api --extra dev pytest api/tests --ignore=api/tests/test_discovery_jobs_integration.py`
  - `uv run --project workers --extra dev pytest workers/tests`
- Files changed:
  - `.github/workflows/ci.yml`
  - `README.md`
  - `docs/roadmap/IMPLEMENTATION_PLAN_v1.2.md`
  - `.agent/CONTINUITY.md`
  - `.agent/execplans/active/EP-2026-02-08__bootstrap-foundation-v1.md`
  - `.agent/notes/2026-02-09_m1-l1-ci-split.md`
- Tests/checks:
  - API fast tests passed (`11/11`).
  - Worker tests passed (`2/2`).

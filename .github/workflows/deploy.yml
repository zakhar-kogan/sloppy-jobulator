name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - staging
          - prod
      run_observability_import:
        description: "Bind and import dashboard/alerts after deploy"
        required: true
        type: boolean
        default: true
      run_telemetry_validation:
        description: "Run telemetry quality validation after deploy"
        required: true
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  deploy-staging:
    if: github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    env:
      GCP_PROJECT_ID: ${{ secrets.SJ_GCP_PROJECT_ID_STAGING }}
      SJ_OBS_ENVIRONMENT: staging
      SJ_OBS_API_CLOUD_RUN_SERVICE: ${{ secrets.SJ_API_SERVICE_NAME_STAGING }}
      SJ_OBS_WORKER_OTEL_SERVICE: ${{ secrets.SJ_WORKER_OTEL_SERVICE_NAME_STAGING }}
      SJ_OBS_NOTIFICATION_CHANNELS: ${{ secrets.SJ_NOTIFICATION_CHANNELS_STAGING }}
      SJ_API_BASE_URL: ${{ secrets.SJ_API_BASE_URL_STAGING }}
      SJ_DEPLOY_API_CMD: ${{ secrets.SJ_DEPLOY_API_CMD_STAGING }}
      SJ_DEPLOY_WORKER_CMD: ${{ secrets.SJ_DEPLOY_WORKER_CMD_STAGING }}
      SJ_DEPLOY_WEB_CMD: ${{ secrets.SJ_DEPLOY_WEB_CMD_STAGING }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate staging secret bindings
        run: |
          required=(
            GCP_PROJECT_ID
            SJ_OBS_API_CLOUD_RUN_SERVICE
            SJ_OBS_WORKER_OTEL_SERVICE
            SJ_OBS_NOTIFICATION_CHANNELS
            SJ_API_BASE_URL
            SJ_DEPLOY_API_CMD
            SJ_DEPLOY_WORKER_CMD
            SJ_DEPLOY_WEB_CMD
          )
          for var_name in "${required[@]}"; do
            if [ -z "${!var_name}" ]; then
              echo "missing required binding: ${var_name}" >&2
              exit 1
            fi
          done

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.SJ_GCP_WORKLOAD_IDENTITY_PROVIDER_STAGING }}
          service_account: ${{ secrets.SJ_GCP_SERVICE_ACCOUNT_STAGING }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy API
        run: bash -lc "${SJ_DEPLOY_API_CMD}"

      - name: Deploy Workers
        run: bash -lc "${SJ_DEPLOY_WORKER_CMD}"

      - name: Deploy Web
        run: bash -lc "${SJ_DEPLOY_WEB_CMD}"

      - name: Import observability assets
        if: github.event.inputs.run_observability_import == 'true'
        run: bash scripts/import-observability-assets.sh

      - name: Validate telemetry quality
        if: github.event.inputs.run_telemetry_validation == 'true'
        run: bash scripts/validate-telemetry-quality.sh

  deploy-prod:
    if: github.event.inputs.environment == 'prod' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    env:
      GCP_PROJECT_ID: ${{ secrets.SJ_GCP_PROJECT_ID_PROD }}
      SJ_OBS_ENVIRONMENT: prod
      SJ_OBS_API_CLOUD_RUN_SERVICE: ${{ secrets.SJ_API_SERVICE_NAME_PROD }}
      SJ_OBS_WORKER_OTEL_SERVICE: ${{ secrets.SJ_WORKER_OTEL_SERVICE_NAME_PROD }}
      SJ_OBS_NOTIFICATION_CHANNELS: ${{ secrets.SJ_NOTIFICATION_CHANNELS_PROD }}
      SJ_API_BASE_URL: ${{ secrets.SJ_API_BASE_URL_PROD }}
      SJ_DEPLOY_API_CMD: ${{ secrets.SJ_DEPLOY_API_CMD_PROD }}
      SJ_DEPLOY_WORKER_CMD: ${{ secrets.SJ_DEPLOY_WORKER_CMD_PROD }}
      SJ_DEPLOY_WEB_CMD: ${{ secrets.SJ_DEPLOY_WEB_CMD_PROD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate prod secret bindings
        run: |
          required=(
            GCP_PROJECT_ID
            SJ_OBS_API_CLOUD_RUN_SERVICE
            SJ_OBS_WORKER_OTEL_SERVICE
            SJ_OBS_NOTIFICATION_CHANNELS
            SJ_API_BASE_URL
            SJ_DEPLOY_API_CMD
            SJ_DEPLOY_WORKER_CMD
            SJ_DEPLOY_WEB_CMD
          )
          for var_name in "${required[@]}"; do
            if [ -z "${!var_name}" ]; then
              echo "missing required binding: ${var_name}" >&2
              exit 1
            fi
          done

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.SJ_GCP_WORKLOAD_IDENTITY_PROVIDER_PROD }}
          service_account: ${{ secrets.SJ_GCP_SERVICE_ACCOUNT_PROD }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy API
        run: bash -lc "${SJ_DEPLOY_API_CMD}"

      - name: Deploy Workers
        run: bash -lc "${SJ_DEPLOY_WORKER_CMD}"

      - name: Deploy Web
        run: bash -lc "${SJ_DEPLOY_WEB_CMD}"

      - name: Import observability assets
        if: github.event.inputs.run_observability_import == 'true'
        run: bash scripts/import-observability-assets.sh

      - name: Validate telemetry quality
        if: github.event.inputs.run_telemetry_validation == 'true'
        run: bash scripts/validate-telemetry-quality.sh
